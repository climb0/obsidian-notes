## 接口幂等性
> 可以理解为调用方对同一接口发起多次相同的请求，服务端应该确保只执行一次相应的操作，并且不论接收到了多少次请求，系统的状态变更始终是一致的，不会因为重复的请求而导致数据的错误。例如订单创建，支付等业务

### 存在的原因
1. 网络波动：丢包、延迟等原因导致服务端的返回在调用方没有收到，从而继续进行"重复"请求，导致接口被重复调用
2. 用户操作：用户快速重复点击提交、刷新提交表单等触发多次调用
3. 重试机制：在高可用的系统设计中，往往都有失败重试机制，以应对临时故障，例如Nginx重试、RPC重试或业务层重试
4. 定时任务或异步处理：定时任务调度或逻辑设计不当，可能会导致同一任务被执行多次，在消息队列中，消息可能会因为异常等原因被重复消费
5. 并发控制：缺乏有效的并发控制手段，导致在并发环境下，针对同一资源的操作被多次执行
### 如何解决
1. 页面控制：页面调用接口时可以通过禁用（按钮置灰或显示加载状态）防止用户在请求未完成前重复点击，只是在行为控制角度来避免重复提交，无法根本杜绝多次请求
2. RPG(POST/Redirect/Get)模式：一种前端交互模式，步骤为：
	1. 通过POST请求服务器进行处理，例如创建新资源或更新现有数据
	2. **服务器接收到POST请求并完成处理后，不直接返回处理结果，而是通过HTTP响应码302或303实现重定向，指示前端发起一个新的GET请求去访问一个特定的URL**
	3. 前端按照重定向，自动发送GET请求访问新的URL，此时后端再返回之前POST操作处理完毕的结果
	4. 这样即使用户在第一次提交后再重复刷新页面，浏览器只会发起GET请求查询之前调用的结果，而非重新发起POST请求，因此有效地避免了重复提交引发的潜在问题
3. Token机制：客户端每次调用都带一个唯一的Token，服务器校验该Token的有效性。如果服务器收到了一个已经使用过的Token就会认为这是一个重复请求并拒绝处理，从而确保接口的幂等性![[Pasted image 20240605194553.png]]
4. 唯一标识符：客户端每次调用都会带一个全局唯一的标识符（例如订单id），服务器首先校验该标识符
	1. 如果已经存在，表明是重复请求，此时可以直接忽略本次请求，或者返回之前处理的结果
	2. 如果不存在，表明是新请求，继续进行正常处理，并将唯一标识符保存至系统中，便于后续对请求进行有效性校验，防止同一请求的重复处理
5. 状态机设计：对于状态转移类的操作业务，可采用状态机设计，每次请求只允许合法的状态转换，不允许非法状态转换（例如已完成的订单不允许再次支付）

## 令牌桶